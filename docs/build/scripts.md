---
sidebar_position: 2
---

# Script Generation

MACE generates comprehensive shell scripts for auditing and remediating macOS security settings. These scripts can be run manually or integrated into your automation workflows.

## Script Types

### Audit Script
The audit script checks each enabled rule and reports compliance status.

```bash
#!/bin/zsh

#####################################
# Compliance Audit Script
# Generated by MACE
# Baseline: DISA STIG macOS 15
# Date: 2024-12-30
#####################################

# Function: os_firewall_log_enable
audit_os_firewall_log_enable() {
    local expected="true"
    local result=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getloggingmode | grep -c "Log mode is on")

    if [[ "$result" == "$expected" ]]; then
        echo "PASS: os_firewall_log_enable"
        return 0
    else
        echo "FAIL: os_firewall_log_enable"
        echo "  Expected: $expected"
        echo "  Found: $result"
        return 1
    fi
}

# ... additional audit functions ...

run_scan() {
    echo "Starting compliance audit..."
    local passed=0
    local failed=0

    audit_os_firewall_log_enable && ((passed++)) || ((failed++))
    # ... run all checks ...

    echo ""
    echo "Audit Complete"
    echo "Passed: $passed"
    echo "Failed: $failed"
}

run_scan
```

### Remediation Script
The fix script applies remediation commands for each rule.

```bash
#!/bin/zsh

#####################################
# Compliance Remediation Script
# Generated by MACE
#####################################

fix_os_firewall_log_enable() {
    echo "Fixing: os_firewall_log_enable"
    /usr/libexec/ApplicationFirewall/socketfilterfw --setloggingmode on
}

run_fix() {
    echo "Starting remediation..."

    fix_os_firewall_log_enable
    # ... apply all fixes ...

    echo "Remediation complete"
}

run_fix
```

### Extension Attributes
Individual scripts formatted for MDM extension attributes:

```bash
#!/bin/zsh
# Extension Attribute: os_firewall_log_enable
# For use with Jamf Pro

result=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getloggingmode | grep -c "Log mode is on")

if [[ "$result" == "1" ]]; then
    echo "<result>Compliant</result>"
else
    echo "<result>Non-Compliant</result>"
fi
```

## Script Features

### Header Documentation
Every script includes:
- Generation metadata (tool, date, baseline)
- Author information
- Baseline version
- Rule count and references

### ODV Substitution
Organization Defined Values are automatically substituted:

```bash
# Before (in YAML):
# password_min_length: $ODV

# After (in script):
password_min_length="15"
```

### Reference Metadata
Scripts include compliance mappings:

```bash
# Rule: os_password_min_length
# STIG ID: V-252532
# CIS: 5.2.1
# NIST 800-53: IA-5(1)
# CCI: CCI-000205
```

### Error Handling
Built-in error handling and logging:

```bash
audit_rule() {
    local result
    if ! result=$(check_command 2>/dev/null); then
        echo "ERROR: os_rule_name - Check failed to execute"
        return 2
    fi
    # ... continue processing
}
```

## Output Modes

### Combined Mode
Single script file containing all rules:
- `audit_compliance.sh` - All audit checks
- `fix_compliance.sh` - All remediation commands

Benefits:
- Single file to manage
- Run entire baseline at once
- Simpler deployment

### Individual Mode
Separate script per rule in `extension_attributes/`:
- `ea_os_firewall_log_enable.sh`
- `ea_os_password_min_length.sh`
- `ea_os_screensaver_timeout.sh`
- etc.

Benefits:
- Deploy specific checks to MDM
- Mix and match as needed
- Easier troubleshooting

## Usage Examples

### Run Full Audit
```bash
sudo ./audit_compliance.sh
```

### Run with Verbose Output
```bash
sudo ./audit_compliance.sh -v
```

### Save Results to File
```bash
sudo ./audit_compliance.sh > audit_results_$(date +%Y%m%d).txt
```

### Run Specific Fix
```bash
# In the script, call individual fix functions:
fix_os_firewall_log_enable
```

### Dry Run (Preview Only)
```bash
sudo ./fix_compliance.sh --dry-run
```

## Integration with MDM

### Jamf Pro

1. **Extension Attributes**
   - Upload individual scripts to Extension Attributes
   - Set data type to String
   - Schedule inventory collection

2. **Policies**
   - Create policy with remediation script
   - Scope to non-compliant computers
   - Set appropriate trigger

### Other MDMs
Scripts work with any MDM that supports:
- Custom script execution
- Shell script deployment
- Extension attribute collection

## Best Practices

1. **Test in Lab First**
   - Always test scripts on non-production systems
   - Verify expected behavior before mass deployment

2. **Review Before Running**
   - Open scripts and review contents
   - Understand what changes will be made

3. **Run Audit Before Fix**
   - Check current state with audit script
   - Identify scope of changes needed

4. **Backup Settings**
   - Consider backing up current configurations
   - Document pre-remediation state

5. **Version Control**
   - Track script changes in git
   - Document baseline versions used
